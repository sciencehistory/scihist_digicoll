<div class="d-flex justify-content-between">

    <div>
      <div class="d-flex align-items-start mt-1">
        <% if @work.representative_id.present? %>
          <%= thumb_image_tag(@work.leaf_representative, size: :mini, image_missing_text: true, class: "mr-2") %>
        <% end %>
        <div>
          <div>Managing a Work</div>
          <h1><%= @work.title %> <%= publication_badge(@work) %>   <%= link_to "Public view", work_path(@work), class: "btn btn-sm btn-outline-primary" %></h1>
          <% if @work.parent.present? %>
            <p class="h4">Member in: <%= link_to "#{@work.parent.title} (#{@work.parent.friendlier_id})", admin_work_path(@work.parent) %></p>
          <% end %>
          <div>
            <%= CartControl.new(@work.friendlier_id, cart_presence: @cart_presence).display %>
          </div>
        </div>
      </div>
    </div>



    <div class="d-flex">
      <% if can? :publish, @work %>
        <div>
          <% if @work.published? %>
            <%= link_to "UN-Publish", unpublish_admin_work_path, method: "put", class: "btn btn-outline-danger" %>
          <% else %>
            <%= link_to "Publish", publish_admin_work_path, method: "put", class: "btn btn-danger" %>
          <% end %>
        </div>
      <% end %>

      <% if can? :destroy, @work %>
        <div>
          <div class="alert alert-secondary mx-1">
            <h2 class="h4 alert-heading">
              <a data-toggle="collapse" href="#deleteBtn1" role="button" aria-expanded="false" aria-controls="deleteBtn1">
                Delete
              </a>
            </h2>
            <div class="collapse" id="deleteBtn1">
                <%= link_to('Delete', [:admin, @work], method: :delete,
                     data: { confirm: "Delete Work '#{@work.title}'?" }, class: "btn btn-danger" )%>
            </div>
          </div>
        </div>
      <% end %>
    </div>
</div>


<nav class="mb-2">
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
    <a class="nav-item nav-link active" id="nav-metadata-tab" data-toggle="tab" href="#nav-metadata" role="tab" aria-controls="nav-home" aria-selected="true">Metadata</a>
    <a class="nav-item nav-link" id="nav-members-tab" data-toggle="tab" href="#nav-members" role="tab" aria-controls="nav-profile" aria-selected="false">Members</a>

    <% if work_is_oral_history? %>
      <a class="nav-item nav-link" id="nav-oral-histories-tab" data-toggle="tab" href="#nav-oral-histories" role="tab" aria-controls="nav-profile" aria-selected="false">Oral History</a>
    <% end %>

  </div>
</nav>

<div class="tab-content">
  <div class="tab-pane show active" id="nav-metadata" role="tabpanel" aria-labelledby="nav-metadata-tab">

        <p>
          <%= link_to "Edit Metadata", edit_admin_work_path(@work), class: "btn btn-primary" %>
          <% if Admin::WorksController.can_demote_to_asset?(@work) %>
            <%= link_to "Demote to Asset",
                  demote_to_asset_admin_work_path(@work),
                  method: "put",
                  class: "btn btn-outline-primary",
                  data: { confirm: "All work metadata on #{@work.title} will be lost, this is not reversible. Are you sure?" } %>
          <% end %>
        </p>

        <%= render "metadata", work: @work %>

  </div>
  <div class="tab-pane" id="nav-members" role="tabpanel" aria-labelledby="nav-members-tab">
    <% if work_is_oral_history? && @work.published? %>
      <div class="admin-work-toolbar d-flex flex-wrap">
        <div class="alert alert-secondary mb-3 mt-2 mx-1 small text-muted">
          <p>This is a published oral history. To protect OHMS derivatives and metadata, many of the functions usually available on this page are disabled.
          </p>
          <p>If you want to add, remove, or reorder interview segments, please:</p>
          <ul>
            <li>unpublish the oral history (this will unpublish all the segments as well);</li>
            <li>make any changes you need to the segments of the oral history;</li>
            <li>republish any and all segments you want to include in the combined audio derivatives;</li>
            <li>regenerate the combined audio derivatives (in the "Oral History" tab);</li>
            <li>republish the oral history.</li>
        </div>
      </div>
    <% end %>

    <div class="admin-work-toolbar d-flex flex-wrap">
      <div class="alert alert-secondary mx-1">
        <h2 class="h4 alert-heading">Add New Members</h2>

        <% if work_is_oral_history? && @work.published?%>
          <small>Please unpublish this oral history if you want to add segments to it.</small>
        <% else %>
          From:
          <%= link_to "Files", admin_asset_ingest_path(@work), class: "btn btn-primary" %>
          <%= link_to "New Child Work", new_admin_work_path(parent_id: @work), class: "btn btn-primary" %>
        <% end %>
      </div>

      <div class="alert alert-secondary mx-1">
        <h2 class="h4 alert-heading">Re-order Members</h2>
        <% if work_is_oral_history? && @work.published?%>
          <small>Please unpublish this oral history if you want to reorder its segments.</small>
        <% else %>
          <%= link_to "Manual", reorder_members_admin_work_path(@work), class: "btn btn-primary" %>
          <%= link_to "Alphabetical", reorder_members_admin_work_path(@work), method: "put", class: "btn btn-primary", data: { confirm: "Re-ordering members alphabetically by title can't be undone" } %>
        <% end %>
      </div>
    </div>

    <p><%= @work.members.count  %> members</p>

    <%= render "member_list_table", work: @work %>
  </div>

  <% if work_is_oral_history? %>

    <div class="tab-pane" id="nav-oral-histories" role="tabpanel" aria-labelledby="nav-oral-histories-tab">

      <%= WorkCombinedAudioDerivatives.new(@work).display %>

      <div class="card bg-light mb-3">
        <h2 class="card-header h3">OHMS XML attached</h2>
        <div class="card-body">
          <dl class="row">
            <% if @work.oral_history_content!.ohms_xml.present? %>
              <dt class="col-sm-6">attached?</dt><dd class="col-sm-6"><span class="text-success font-weight-bold">YES</span></dd>
              <dt class="col-sm-6">id</dt><dd class="col-sm-6"><%= @work.oral_history_content!.ohms_xml.record_id %></dd>
              <dt class="col-sm-6">dt</dt><dd class="col-sm-6"><%= @work.oral_history_content!.ohms_xml.record_dt %></dd>
              <dt class="col-sm-6">accession</dt><dd class="col-sm-6"><%= @work.oral_history_content!.ohms_xml.accession %></dd>
            <% else %>
              <dt class="col-sm-6">attached?</dt><dd class="col-sm-6"><span class="text-danger font-weight-bold">NO</span></dd>
            <% end %>
          </dl>
          <hr>
          <h3 class="h4">Upload New OHMS XML file</h3>
          <%= form_with(url: submit_ohms_xml_admin_work_path(@work), local: true, multipart: true, method: :put) do %>
            <%= file_field_tag 'ohms_xml', accept: "application/xml" %>
            <%= submit_tag "Upload", class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

