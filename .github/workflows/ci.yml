name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ '**' ]

env:
  # these are all referenced in our app's database.yml for test
  POSTGRES_HOST: localhost
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres

jobs:
  tests:
    services:
      db:
        image: postgres:9.6
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']

    runs-on: ubuntu-latest

    steps:
        - uses: actions/checkout@v2

        - name: Set up Ruby
          uses: ruby/setup-ruby@v1
          with:
            bundler-cache: true
            # should take ruby version from .ruby-version,
            # bundler-cache should be save to use cause we
            # have a checked in Gemfile.lock

        - name: Install CLI shell-out dependencies
          run: |
            sudo apt-get install libvips-tools
            sudo apt-get install ffmpeg
            sudo apt-get install mediainfo

        - name: Set up app
          run: |
            RAILS_ENV=test bundle exec rails db:create
            yarn install

        - name: Run tests
          run: |
            bundle exec rspec




